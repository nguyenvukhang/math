name: CI

on:
  push:

permissions:
  contents: write

jobs:
  build-pdf:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: main

      - uses: actions/checkout@v4
        with:
          ref: pdf
          path: pdf

      - name: Generate single .tex files
        working-directory: main
        run: bash .github/workflows/build.sh

      - uses: xu-cheng/latex-action@v3
        with:
          docker_image: ghcr.io/xu-cheng/texlive-small:latest
          working_directory: main
          root_file: .ci/*.tex
        env:
          TEXINPUTS: "tex_modules/:"

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # set git hash
          GIT_HASH=${{ github.sha }}
          GIT_HASH=${GIT_HASH:0:7}
          echo "GIT_HASH=$GIT_HASH" >> "$GITHUB_ENV"

      - name: Push PDFs to pdf branch
        if: ${{ github.ref_name == 'main' }}
        working-directory: pdf
        run: |
          echo "Clearing out old files"
          rm -f *

          echo "Importing built pdfs"
          cp ../main/*.pdf .

          echo "Stage pdfs"
          git add --all

          echo "Checking for changes"
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes found!"
          else
            echo "Changes found! Committing..."
            D='Dec 14 2022 12:12:00 +0800'
            GIT_AUTHOR_DATE=$D GIT_COMMITTER_DATE=$D \
              git commit --amend --no-edit -m "[$GIT_HASH]"
            echo "Pushing..."
            git push -f
          fi

      - name: Release PDF
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          files: pdf/*.pdf
