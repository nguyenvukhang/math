name: CI

on:
  push:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

permissions:
  contents: write

jobs:
  build-pdf:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: configure git + environment variables
        run: |
          # set git user for git commits
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # set git hash
          GIT_HASH=${{ github.sha }}
          GIT_HASH=${GIT_HASH:0:7}
          echo "GIT_HASH=$GIT_HASH" >> "$GITHUB_ENV"

          # set minimath binary path
          echo "MINIMATH=./target/debug/minimath" >> "$GITHUB_ENV"

      - run: cargo build --quiet

      - name: checkhealth
        run: $MINIMATH checkhealth

      - run: find *
      - run: ls target/debug

      - name: rust compile
        run: |
          $MINIMATH build -J minimath toc.tex \
            plenary.tex \
            calculus.tex \
            algorithm-design.tex \
            complex-analysis.tex \
            nonlinear-optimization-unconstrained.tex \
            nonlinear-optimization-constrained.tex \
            ordinary-differential-equations.tex

      - name: latex build
        uses: xu-cheng/latex-action@v3
        with:
          docker_image: ghcr.io/xu-cheng/texlive-small:latest
          root_file: .git/.build/*.tex
        env:
          TEXINPUTS: "tex_modules/:"

      - name: â–² vercel build
        if: ${{ github.ref_name == 'main' }}
        run: |
          cp minimath.pdf web/public/minimath.pdf
          npm i -g vercel@latest
          vercel=${{ secrets.VERCEL_TOKEN }}
          vercel="vercel -t $vercel"
          $vercel pull --yes --environment=production
          $vercel build --prod
          $vercel deploy --prebuilt --prod

      - name: push pdfs to pdf branch
        if: ${{ github.ref_name == 'main' }}
        run: |
          cp *.pdf README.md -- .git
          git checkout --orphan pdf
          git rm -rf .
          sudo cp .git/*.pdf .git/README.md -- .
          git add *.pdf README.md
          D='Dec 14 2022 12:12:00 +0800'
          GIT_AUTHOR_DATE=$D GIT_COMMITTER_DATE=$D git commit -m "[$GIT_HASH]"
          git push -f origin pdf

      - name: release pdf
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          files: ./*.pdf
